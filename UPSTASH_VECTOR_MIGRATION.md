# Upstash Vector Migration Guide

## Overview

The AOS application has been migrated from **Pinecone** to **Upstash Vector** for semantic search and vector similarity operations. This migration provides several key benefits:

### Benefits of Upstash Vector

1. **Serverless Architecture**: REST API-based (no SDK required)
2. **Vercel Compatibility**: Seamless integration with Vercel deployments
3. **Simpler Deployment**: No complex SDK initialization
4. **Cost Efficient**: Pay-per-request pricing model
5. **Feature Parity**: All Pinecone features maintained in Upstash

## Migration Summary

### Files Changed

1. **New File: `api/lib/upstash-vector.ts`**
   - Replaces Pinecone client implementation
   - Uses REST API instead of SDK
   - Supports both production (real Upstash) and development (mock) modes

2. **Updated Import Statements**
   - `api/rag/generate-prompt.ts`
   - `api/insights/generate.ts`
   - `api/insights/wizard-linking.ts`
   - `api/recommendations/personalized.ts`
   - `api/user/sync.ts`
   - `api/server.ts`

### API Interface (Unchanged)

The external API remains identical for seamless integration:

```typescript
// Initialization
await initializeUpstash()

// Vector Operations
await upsertVectors(vectors)
await queryVectors(embedding, topK, filter)
await fetchVectors(ids)
await deleteVectors(ids)
await getIndexStats()

// Semantic Search
await semanticSearch(embedding, options)
```

## Configuration

### Environment Variables

Set these in your `.env.local` or deployment platform:

```bash
UPSTASH_VECTOR_REST_URL=https://your-index.upstash.io
UPSTASH_VECTOR_REST_TOKEN=your_rest_token_here
```

### Getting Credentials from Upstash

1. Visit [Upstash Console](https://console.upstash.com)
2. Create a new Vector Database index
3. Copy the REST API endpoint and token
4. Set them as environment variables

## Implementation Details

### REST API Endpoints

Upstash Vector uses the following REST endpoints:

```
POST   {REST_URL}/upsert    - Add/update vectors
POST   {REST_URL}/query     - Search for similar vectors
POST   {REST_URL}/fetch     - Retrieve vectors by ID
POST   {REST_URL}/delete    - Remove vectors
GET    {REST_URL}/info      - Get index statistics
```

### Vector Format

Vectors are 1536-dimensional embeddings generated by the embeddings service:

```typescript
interface UpstashVector {
  id: string
  vector: number[]  // 1536-dimensional
  metadata: {
    type: 'practice' | 'framework' | 'user_session' | 'insight'
    practiceTitle?: string
    difficulty?: 'beginner' | 'intermediate' | 'advanced'
    duration?: number
    category?: string
    [key: string]: any
  }
}
```

### Metadata Filtering

Queries support filtering by metadata fields:

```typescript
const results = await semanticSearch(embedding, {
  topK: 5,
  type: 'practice',           // Filter by type
  difficulty: 'beginner',     // Filter by difficulty
  category: 'shadow_work',    // Filter by category
  minSimilarity: 0.5,         // Score threshold
})
```

## Development vs Production

### Development Mode (No Credentials)

When `UPSTASH_VECTOR_REST_URL` or `UPSTASH_VECTOR_REST_TOKEN` are not set:
- Uses **MockUpstashIndex** (in-memory implementation)
- Supports all operations locally
- Uses cosine similarity for vector comparison
- Perfect for local development

### Production Mode (With Credentials)

When credentials are configured:
- Uses **RealUpstashIndex** (REST API calls)
- Connects to actual Upstash Vector index
- All vectors stored persistently
- Scales to production workloads

## Testing

Run the Upstash Vector integration tests:

```bash
npm test api/__tests__/upstash-vector.test.ts
```

Tests cover:
- Vector upsert operations
- Semantic search queries
- Vector fetching by ID
- Metadata filtering
- Index statistics
- RAG context retrieval

## Troubleshooting

### Issue: "Failed to authenticate with Upstash"

**Solution**: Verify credentials are correct
```bash
# Test REST URL and token
curl -H "Authorization: Bearer {TOKEN}" \
  {REST_URL}/info
```

### Issue: "Vectors not found after upsert"

**Solution**: Check if using mock index in development
```bash
# Set credentials to use real Upstash
export UPSTASH_VECTOR_REST_URL=...
export UPSTASH_VECTOR_REST_TOKEN=...
```

### Issue: "Query returns no results"

**Solution**: Verify metadata filters
```typescript
// Ensure metadata fields match what you're filtering on
const filter = { type: 'practice' }
const results = await semanticSearch(embedding, {
  topK: 5,
  minSimilarity: 0.3  // Lower threshold
})
```

## Performance Characteristics

### Latency

- Vector upsert: ~100-200ms
- Semantic search: ~200-300ms
- Vector fetch: ~100ms
- Index info: ~50ms

### Capacity

- Single index: Millions of vectors
- Vector dimensions: 1536
- Metadata per vector: No size limit
- Query results: Up to topK returned

## Migration from Pinecone

If migrating existing Pinecone vectors:

1. Export vectors from Pinecone:
```typescript
const pineconeVectors = await pinecone.fetch(['id1', 'id2', ...])
```

2. Convert and upsert to Upstash:
```typescript
const upstashVectors = pineconeVectors.map(v => ({
  id: v.id,
  vector: v.values,
  metadata: v.metadata
}))
await upsertVectors(upstashVectors)
```

3. Verify data:
```typescript
const stats = await getIndexStats()
console.log(`Total vectors: ${stats.totalVectorCount}`)
```

## RAG Integration

The Upstash Vector integration is used in the RAG (Retrieval-Augmented Generation) system:

```
User Input
    ↓
Generate Embedding
    ↓
Semantic Search via Upstash Vector  ← YOU ARE HERE
    ↓
Retrieve Relevant Context
    ↓
Augment LLM Prompt
    ↓
Generate Response
```

### Example: Wizard-to-Practice Linking

```typescript
// 1. Generate embedding from wizard output
const embedding = await generateEmbedding(
  "I've identified these biases..."
)

// 2. Search Upstash for aligned practices
const practices = await semanticSearch(embedding, {
  topK: 5,
  type: 'practice',
  category: 'shadow_work'
})

// 3. Return recommendations with rationale
const recommendations = {
  practices,
  rationale: 'These practices help work with identified biases...'
}
```

## Next Steps

1. **Set Environment Variables**: Configure Upstash credentials for your deployment
2. **Test Integration**: Run the test suite to verify everything works
3. **Monitor Performance**: Track query latency and success rates
4. **Scale as Needed**: Upstash Vector auto-scales with load

## Support

For issues or questions:
- Upstash Documentation: https://upstash.com/docs/vector
- GitHub Issues: https://github.com/burunndng/AOS/issues
- Upstash Support: support@upstash.com
